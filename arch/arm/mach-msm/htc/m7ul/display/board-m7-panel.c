/* Copyright (c) 2012, Code Aurora Forum. All rights reserved.
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License version 2 and
 * only version 2 as published by the Free Software Foundation.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 */

#include <linux/init.h>
#include <linux/ioport.h>
#include <linux/platform_device.h>
#include <linux/bootmem.h>
#include <linux/ion.h>
#include <asm/mach-types.h>
#include <mach/msm_memtypes.h>
#include <mach/board.h>
#include <mach/gpio.h>
#include <mach/gpiomux.h>
#include <mach/ion.h>
#include <mach/msm_bus_board.h>
#include <mach/panel_id.h>
#include <mach/debug_display.h>
#include <linux/gpio.h>
#include "devices.h"
#include "../board-m7.h"
#include <linux/mfd/pm8xxx/pm8921.h>
#include <mach/gpio.h>
#include <mach/gpiomux.h>
#include "../../../../drivers/video/msm/msm_fb.h"
#include "../../../../drivers/video/msm/mipi_dsi.h"
#include "../../../../drivers/video/msm/mdp4.h"
#include <linux/i2c.h>
#include <mach/msm_xo.h>

#ifdef CONFIG_FB_MSM_TRIPLE_BUFFER
#define MSM_FB_PRIM_BUF_SIZE (1920 * ALIGN(1080, 32) * 4 * 3)
#else
#define MSM_FB_PRIM_BUF_SIZE (1920 * ALIGN(1080, 32) * 4 * 2)
#endif

#define MSM_FB_SIZE roundup(MSM_FB_PRIM_BUF_SIZE, 4096)

#ifdef CONFIG_FB_MSM_OVERLAY0_WRITEBACK
#define MSM_FB_OVERLAY0_WRITEBACK_SIZE roundup((1920 * 1080 * 3 * 2), 4096)
#else
#define MSM_FB_OVERLAY0_WRITEBACK_SIZE (0)
#endif  

#ifdef CONFIG_FB_MSM_OVERLAY1_WRITEBACK
#define MSM_FB_OVERLAY1_WRITEBACK_SIZE roundup((1920 * 1088 * 3 * 2), 4096)
#else
#define MSM_FB_OVERLAY1_WRITEBACK_SIZE (0)
#endif  

static struct resource msm_fb_resources[] = {
	{
		.flags = IORESOURCE_DMA,
	}
};

struct msm_xo_voter *wa_xo;

static struct msm_fb_platform_data msm_fb_pdata;

static struct platform_device msm_fb_device = {
	.name              = "msm_fb",
	.id                = 0,
	.num_resources     = ARRAY_SIZE(msm_fb_resources),
	.resource          = msm_fb_resources,
	.dev.platform_data = &msm_fb_pdata,
};

void __init m7_allocate_fb_region(void)
{
	void *addr;
	unsigned long size;

	size = MSM_FB_SIZE;
	addr = alloc_bootmem_align(size, 0x1000);
	msm_fb_resources[0].start = __pa(addr);
	msm_fb_resources[0].end = msm_fb_resources[0].start + size - 1;
	pr_info("allocating %lu bytes at %p (%lx physical) for fb\n",
			size, addr, __pa(addr));
}

#define MDP_VSYNC_GPIO 0

#ifdef CONFIG_MSM_BUS_SCALING
static struct msm_bus_vectors mdp_init_vectors[] = {
	{
		.src = MSM_BUS_MASTER_MDP_PORT0,
		.dst = MSM_BUS_SLAVE_EBI_CH0,
		.ab = 0,
		.ib = 0,
	},
};

static struct msm_bus_vectors mdp_ui_vectors[] = {
	{
		.src = MSM_BUS_MASTER_MDP_PORT0,
		.dst = MSM_BUS_SLAVE_EBI_CH0,
		.ab = 216000000 * 2,
		.ib = 270000000 * 2,
	},
};

static struct msm_bus_vectors mdp_vga_vectors[] = {
	
	{
		.src = MSM_BUS_MASTER_MDP_PORT0,
		.dst = MSM_BUS_SLAVE_EBI_CH0,
		.ab = 216000000 * 2,
		.ib = 270000000 * 2,
	},
};

static struct msm_bus_vectors mdp_720p_vectors[] = {
	
	{
		.src = MSM_BUS_MASTER_MDP_PORT0,
		.dst = MSM_BUS_SLAVE_EBI_CH0,
		.ab = 230400000 * 2,
		.ib = 288000000 * 2,
	},
};

static struct msm_bus_vectors mdp_1080p_vectors[] = {
	
	{
		.src = MSM_BUS_MASTER_MDP_PORT0,
		.dst = MSM_BUS_SLAVE_EBI_CH0,
		.ab = 334080000 * 2,
		.ib = 417600000 * 2,
	},
};

static struct msm_bus_paths mdp_bus_scale_usecases[] = {
	{
		ARRAY_SIZE(mdp_init_vectors),
		mdp_init_vectors,
	},
	{
		ARRAY_SIZE(mdp_ui_vectors),
		mdp_ui_vectors,
	},
	{
		ARRAY_SIZE(mdp_ui_vectors),
		mdp_ui_vectors,
	},
	{
		ARRAY_SIZE(mdp_vga_vectors),
		mdp_vga_vectors,
	},
	{
		ARRAY_SIZE(mdp_720p_vectors),
		mdp_720p_vectors,
	},
	{
		ARRAY_SIZE(mdp_1080p_vectors),
		mdp_1080p_vectors,
	},
};

static struct msm_bus_scale_pdata mdp_bus_scale_pdata = {
	mdp_bus_scale_usecases,
	ARRAY_SIZE(mdp_bus_scale_usecases),
	.name = "mdp",
};

static struct msm_bus_vectors dtv_bus_init_vectors[] = {
	{
		.src = MSM_BUS_MASTER_MDP_PORT0,
		.dst = MSM_BUS_SLAVE_EBI_CH0,
		.ab = 0,
		.ib = 0,
	},
};

static struct msm_bus_vectors dtv_bus_def_vectors[] = {
	{
		.src = MSM_BUS_MASTER_MDP_PORT0,
		.dst = MSM_BUS_SLAVE_EBI_CH0,
		.ab = 566092800 * 2,
		.ib = 707616000 * 2,
	},
};

static struct msm_bus_paths dtv_bus_scale_usecases[] = {
	{
		ARRAY_SIZE(dtv_bus_init_vectors),
		dtv_bus_init_vectors,
	},
	{
		ARRAY_SIZE(dtv_bus_def_vectors),
		dtv_bus_def_vectors,
	},
};

static struct msm_bus_scale_pdata dtv_bus_scale_pdata = {
	dtv_bus_scale_usecases,
	ARRAY_SIZE(dtv_bus_scale_usecases),
	.name = "dtv",
};

static struct lcdc_platform_data dtv_pdata = {
	.bus_scale_table = &dtv_bus_scale_pdata,
};
#endif

#if 0
struct mdp_reg *mdp_gamma = NULL;
int mdp_gamma_count = 0;
struct mdp_reg mdp_gamma_jdi[] = {
        {0x94800, 0x000000, 0x0},
        {0x94804, 0x000100, 0x0},
        {0x94808, 0x010201, 0x0},
        {0x9480C, 0x020302, 0x0},
        {0x94810, 0x030403, 0x0},
        {0x94814, 0x040504, 0x0},
        {0x94818, 0x050605, 0x0},
        {0x9481C, 0x060706, 0x0},
        {0x94820, 0x070807, 0x0},
        {0x94824, 0x080908, 0x0},
        {0x94828, 0x090A09, 0x0},
        {0x9482C, 0x0A0B0A, 0x0},
        {0x94830, 0x0B0C0B, 0x0},
        {0x94834, 0x0B0D0C, 0x0},
        {0x94838, 0x0C0E0D, 0x0},
        {0x9483C, 0x0D0F0E, 0x0},
        {0x94840, 0x0E100F, 0x0},
        {0x94844, 0x0F1110, 0x0},
        {0x94848, 0x101210, 0x0},
        {0x9484C, 0x111311, 0x0},
        {0x94850, 0x121412, 0x0},
        {0x94854, 0x131513, 0x0},
        {0x94858, 0x141614, 0x0},
        {0x9485C, 0x151715, 0x0},
        {0x94860, 0x161816, 0x0},
        {0x94864, 0x161917, 0x0},
        {0x94868, 0x171A18, 0x0},
        {0x9486C, 0x181B19, 0x0},
        {0x94870, 0x191C1A, 0x0},
        {0x94874, 0x1A1D1B, 0x0},
        {0x94878, 0x1B1E1C, 0x0},
        {0x9487C, 0x1C1F1D, 0x0},
        {0x94880, 0x1D201E, 0x0},
        {0x94884, 0x1E211F, 0x0},
        {0x94888, 0x1F2220, 0x0},
        {0x9488C, 0x202320, 0x0},
        {0x94890, 0x212421, 0x0},
        {0x94894, 0x212522, 0x0},
        {0x94898, 0x222623, 0x0},
        {0x9489C, 0x232724, 0x0},
        {0x948A0, 0x242825, 0x0},
        {0x948A4, 0x252926, 0x0},
        {0x948A8, 0x262A27, 0x0},
        {0x948AC, 0x272B28, 0x0},
        {0x948B0, 0x282C29, 0x0},
        {0x948B4, 0x292D2A, 0x0},
        {0x948B8, 0x2A2E2B, 0x0},
        {0x948BC, 0x2B2F2C, 0x0},
        {0x948C0, 0x2C302D, 0x0},
        {0x948C4, 0x2C312E, 0x0},
        {0x948C8, 0x2D322F, 0x0},
        {0x948CC, 0x2E3330, 0x0},
        {0x948D0, 0x2F3430, 0x0},
        {0x948D4, 0x303531, 0x0},
        {0x948D8, 0x313632, 0x0},
        {0x948DC, 0x323733, 0x0},
        {0x948E0, 0x333834, 0x0},
        {0x948E4, 0x343935, 0x0},
        {0x948E8, 0x353A36, 0x0},
        {0x948EC, 0x363B37, 0x0},
        {0x948F0, 0x373C38, 0x0},
        {0x948F4, 0x373D39, 0x0},
        {0x948F8, 0x383E3A, 0x0},
        {0x948FC, 0x393F3B, 0x0},
        {0x94900, 0x3A403C, 0x0},
        {0x94904, 0x3B413D, 0x0},
        {0x94908, 0x3C423E, 0x0},
        {0x9490C, 0x3D433F, 0x0},
        {0x94910, 0x3E4440, 0x0},
        {0x94914, 0x3F4540, 0x0},
        {0x94918, 0x404641, 0x0},
        {0x9491C, 0x414742, 0x0},
        {0x94920, 0x424843, 0x0},
        {0x94924, 0x424944, 0x0},
        {0x94928, 0x434A45, 0x0},
        {0x9492C, 0x444B46, 0x0},
        {0x94930, 0x454C47, 0x0},
        {0x94934, 0x464D48, 0x0},
        {0x94938, 0x474E49, 0x0},
        {0x9493C, 0x484F4A, 0x0},
        {0x94940, 0x49504B, 0x0},
        {0x94944, 0x4A514C, 0x0},
        {0x94948, 0x4B524D, 0x0},
        {0x9494C, 0x4C534E, 0x0},
        {0x94950, 0x4D544F, 0x0},
        {0x94954, 0x4E5550, 0x0},
        {0x94958, 0x4E5650, 0x0},
        {0x9495C, 0x4F5751, 0x0},
        {0x94960, 0x505852, 0x0},
        {0x94964, 0x515953, 0x0},
        {0x94968, 0x525A54, 0x0},
        {0x9496C, 0x535B55, 0x0},
        {0x94970, 0x545C56, 0x0},
        {0x94974, 0x555D57, 0x0},
        {0x94978, 0x565E58, 0x0},
        {0x9497C, 0x575F59, 0x0},
        {0x94980, 0x58605A, 0x0},
        {0x94984, 0x59615B, 0x0},
        {0x94988, 0x59625C, 0x0},
        {0x9498C, 0x5A635D, 0x0},
        {0x94990, 0x5B645E, 0x0},
        {0x94994, 0x5C655F, 0x0},
        {0x94998, 0x5D6660, 0x0},
        {0x9499C, 0x5E6760, 0x0},
        {0x949A0, 0x5F6861, 0x0},
        {0x949A4, 0x606962, 0x0},
        {0x949A8, 0x616A63, 0x0},
        {0x949AC, 0x626B64, 0x0},
        {0x949B0, 0x636C65, 0x0},
        {0x949B4, 0x646D66, 0x0},
        {0x949B8, 0x646E67, 0x0},
        {0x949BC, 0x656F68, 0x0},
        {0x949C0, 0x667069, 0x0},
        {0x949C4, 0x67716A, 0x0},
        {0x949C8, 0x68726B, 0x0},
        {0x949CC, 0x69736C, 0x0},
        {0x949D0, 0x6A746D, 0x0},
        {0x949D4, 0x6B756E, 0x0},
        {0x949D8, 0x6C766F, 0x0},
        {0x949DC, 0x6D7770, 0x0},
        {0x949E0, 0x6E7870, 0x0},
        {0x949E4, 0x6F7971, 0x0},
        {0x949E8, 0x6F7A72, 0x0},
        {0x949EC, 0x707B73, 0x0},
        {0x949F0, 0x717C74, 0x0},
        {0x949F4, 0x727D75, 0x0},
        {0x949F8, 0x737E76, 0x0},
        {0x949FC, 0x747F77, 0x0},
        {0x94A00, 0x758078, 0x0},
        {0x94A04, 0x768179, 0x0},
        {0x94A08, 0x77827A, 0x0},
        {0x94A0C, 0x78837B, 0x0},
        {0x94A10, 0x79847C, 0x0},
        {0x94A14, 0x7A857D, 0x0},
        {0x94A18, 0x7A867E, 0x0},
        {0x94A1C, 0x7B877F, 0x0},
        {0x94A20, 0x7C8880, 0x0},
        {0x94A24, 0x7D8980, 0x0},
        {0x94A28, 0x7E8A81, 0x0},
        {0x94A2C, 0x7F8B82, 0x0},
        {0x94A30, 0x808C83, 0x0},
        {0x94A34, 0x818D84, 0x0},
        {0x94A38, 0x828E85, 0x0},
        {0x94A3C, 0x838F86, 0x0},
        {0x94A40, 0x849087, 0x0},
        {0x94A44, 0x859188, 0x0},
        {0x94A48, 0x859289, 0x0},
        {0x94A4C, 0x86938A, 0x0},
        {0x94A50, 0x87948B, 0x0},
        {0x94A54, 0x88958C, 0x0},
        {0x94A58, 0x89968D, 0x0},
        {0x94A5C, 0x8A978E, 0x0},
        {0x94A60, 0x8B988F, 0x0},
        {0x94A64, 0x8C9990, 0x0},
        {0x94A68, 0x8D9A90, 0x0},
        {0x94A6C, 0x8E9B91, 0x0},
        {0x94A70, 0x8F9C92, 0x0},
        {0x94A74, 0x909D93, 0x0},
        {0x94A78, 0x909E94, 0x0},
        {0x94A7C, 0x919F95, 0x0},
        {0x94A80, 0x92A096, 0x0},
        {0x94A84, 0x93A197, 0x0},
        {0x94A88, 0x94A298, 0x0},
        {0x94A8C, 0x95A399, 0x0},
        {0x94A90, 0x96A49A, 0x0},
        {0x94A94, 0x97A59B, 0x0},
        {0x94A98, 0x98A69C, 0x0},
        {0x94A9C, 0x99A79D, 0x0},
        {0x94AA0, 0x9AA89E, 0x0},
        {0x94AA4, 0x9BA99F, 0x0},
        {0x94AA8, 0x9CAAA0, 0x0},
        {0x94AAC, 0x9CABA0, 0x0},
        {0x94AB0, 0x9DACA1, 0x0},
        {0x94AB4, 0x9EADA2, 0x0},
        {0x94AB8, 0x9FAEA3, 0x0},
        {0x94ABC, 0xA0AFA4, 0x0},
        {0x94AC0, 0xA1B0A5, 0x0},
        {0x94AC4, 0xA2B1A6, 0x0},
        {0x94AC8, 0xA3B2A7, 0x0},
        {0x94ACC, 0xA4B3A8, 0x0},
        {0x94AD0, 0xA5B4A9, 0x0},
        {0x94AD4, 0xA6B5AA, 0x0},
        {0x94AD8, 0xA7B6AB, 0x0},
        {0x94ADC, 0xA7B7AC, 0x0},
        {0x94AE0, 0xA8B8AD, 0x0},
        {0x94AE4, 0xA9B9AE, 0x0},
        {0x94AE8, 0xAABAAF, 0x0},
        {0x94AEC, 0xABBBB0, 0x0},
        {0x94AF0, 0xACBCB0, 0x0},
        {0x94AF4, 0xADBDB1, 0x0},
        {0x94AF8, 0xAEBEB2, 0x0},
        {0x94AFC, 0xAFBFB3, 0x0},
        {0x94B00, 0xB0C0B4, 0x0},
        {0x94B04, 0xB1C1B5, 0x0},
        {0x94B08, 0xB2C2B6, 0x0},
        {0x94B0C, 0xB2C3B7, 0x0},
        {0x94B10, 0xB3C4B8, 0x0},
        {0x94B14, 0xB4C5B9, 0x0},
        {0x94B18, 0xB5C6BA, 0x0},
        {0x94B1C, 0xB6C7BB, 0x0},
        {0x94B20, 0xB7C8BC, 0x0},
        {0x94B24, 0xB8C9BD, 0x0},
        {0x94B28, 0xB9CABE, 0x0},
        {0x94B2C, 0xBACBBF, 0x0},
        {0x94B30, 0xBBCCC0, 0x0},
        {0x94B34, 0xBCCDC0, 0x0},
        {0x94B38, 0xBDCEC1, 0x0},
        {0x94B3C, 0xBDCFC2, 0x0},
        {0x94B40, 0xBED0C3, 0x0},
        {0x94B44, 0xBFD1C4, 0x0},
        {0x94B48, 0xC0D2C5, 0x0},
        {0x94B4C, 0xC1D3C6, 0x0},
        {0x94B50, 0xC2D4C7, 0x0},
        {0x94B54, 0xC3D5C8, 0x0},
        {0x94B58, 0xC4D6C9, 0x0},
        {0x94B5C, 0xC5D7CA, 0x0},
        {0x94B60, 0xC6D8CB, 0x0},
        {0x94B64, 0xC7D9CC, 0x0},
        {0x94B68, 0xC8DACD, 0x0},
        {0x94B6C, 0xC8DBCE, 0x0},
        {0x94B70, 0xC9DCCF, 0x0},
        {0x94B74, 0xCADDD0, 0x0},
        {0x94B78, 0xCBDED0, 0x0},
        {0x94B7C, 0xCCDFD1, 0x0},
        {0x94B80, 0xCDE0D2, 0x0},
        {0x94B84, 0xCEE1D3, 0x0},
        {0x94B88, 0xCFE2D4, 0x0},
        {0x94B8C, 0xD0E3D5, 0x0},
        {0x94B90, 0xD1E4D6, 0x0},
        {0x94B94, 0xD2E5D7, 0x0},
        {0x94B98, 0xD3E6D8, 0x0},
        {0x94B9C, 0xD3E7D9, 0x0},
        {0x94BA0, 0xD4E8DA, 0x0},
        {0x94BA4, 0xD5E9DB, 0x0},
        {0x94BA8, 0xD6EADC, 0x0},
        {0x94BAC, 0xD7EBDD, 0x0},
        {0x94BB0, 0xD8ECDE, 0x0},
        {0x94BB4, 0xD9EDDF, 0x0},
        {0x94BB8, 0xDAEEE0, 0x0},
        {0x94BBC, 0xDBEFE0, 0x0},
        {0x94BC0, 0xDCF0E1, 0x0},
        {0x94BC4, 0xDDF1E2, 0x0},
        {0x94BC8, 0xDEF2E3, 0x0},
        {0x94BCC, 0xDEF3E4, 0x0},
        {0x94BD0, 0xDFF4E5, 0x0},
        {0x94BD4, 0xE0F5E6, 0x0},
        {0x94BD8, 0xE1F6E7, 0x0},
        {0x94BDC, 0xE2F7E8, 0x0},
        {0x94BE0, 0xE3F8E9, 0x0},
        {0x94BE4, 0xE4F9EA, 0x0},
        {0x94BE8, 0xE5FAEB, 0x0},
        {0x94BEC, 0xE6FBEC, 0x0},
        {0x94BF0, 0xE7FCED, 0x0},
        {0x94BF4, 0xE8FDEE, 0x0},
        {0x94BF8, 0xE9FEEF, 0x0},
        {0x94BFC, 0xEAFFF0, 0x0},
        {0x90070, 0x0F, 0x0},
};

struct mdp_reg mdp_gamma_renesas[] = {
        {0x94800, 0x000000, 0x0},
        {0x94804, 0x010101, 0x0},
        {0x94808, 0x020202, 0x0},
        {0x9480C, 0x030303, 0x0},
        {0x94810, 0x040404, 0x0},
        {0x94814, 0x050505, 0x0},
        {0x94818, 0x060606, 0x0},
        {0x9481C, 0x070707, 0x0},
        {0x94820, 0x080808, 0x0},
        {0x94824, 0x090909, 0x0},
        {0x94828, 0x0A0A0A, 0x0},
        {0x9482C, 0x0B0B0B, 0x0},
        {0x94830, 0x0C0C0C, 0x0},
        {0x94834, 0x0D0D0D, 0x0},
        {0x94838, 0x0E0E0E, 0x0},
        {0x9483C, 0x0F0F0F, 0x0},
        {0x94840, 0x101010, 0x0},
        {0x94844, 0x111111, 0x0},
        {0x94848, 0x121212, 0x0},
        {0x9484C, 0x131313, 0x0},
        {0x94850, 0x141414, 0x0},
        {0x94854, 0x151515, 0x0},
        {0x94858, 0x161616, 0x0},
        {0x9485C, 0x171717, 0x0},
        {0x94860, 0x181818, 0x0},
        {0x94864, 0x191919, 0x0},
        {0x94868, 0x1A1A1A, 0x0},
        {0x9486C, 0x1B1B1B, 0x0},
        {0x94870, 0x1C1C1C, 0x0},
        {0x94874, 0x1D1D1D, 0x0},
        {0x94878, 0x1E1E1E, 0x0},
        {0x9487C, 0x1F1F1F, 0x0},
        {0x94880, 0x202020, 0x0},
        {0x94884, 0x212121, 0x0},
        {0x94888, 0x222222, 0x0},
        {0x9488C, 0x232323, 0x0},
        {0x94890, 0x242424, 0x0},
        {0x94894, 0x252525, 0x0},
        {0x94898, 0x262626, 0x0},
        {0x9489C, 0x272727, 0x0},
        {0x948A0, 0x282828, 0x0},
        {0x948A4, 0x292929, 0x0},
        {0x948A8, 0x2A2A2A, 0x0},
        {0x948AC, 0x2B2B2B, 0x0},
        {0x948B0, 0x2C2C2C, 0x0},
        {0x948B4, 0x2D2D2D, 0x0},
        {0x948B8, 0x2E2E2E, 0x0},
        {0x948BC, 0x2F2F2F, 0x0},
        {0x948C0, 0x303030, 0x0},
        {0x948C4, 0x313131, 0x0},
        {0x948C8, 0x323232, 0x0},
        {0x948CC, 0x333333, 0x0},
        {0x948D0, 0x343434, 0x0},
        {0x948D4, 0x353535, 0x0},
        {0x948D8, 0x363636, 0x0},
        {0x948DC, 0x373737, 0x0},
        {0x948E0, 0x383838, 0x0},
        {0x948E4, 0x393939, 0x0},
        {0x948E8, 0x3A3A3A, 0x0},
        {0x948EC, 0x3B3B3B, 0x0},
        {0x948F0, 0x3C3C3C, 0x0},
        {0x948F4, 0x3D3D3D, 0x0},
        {0x948F8, 0x3E3E3E, 0x0},
        {0x948FC, 0x3F3F3F, 0x0},
        {0x94900, 0x404040, 0x0},
        {0x94904, 0x414141, 0x0},
        {0x94908, 0x424242, 0x0},
        {0x9490C, 0x434343, 0x0},
        {0x94910, 0x444444, 0x0},
        {0x94914, 0x454545, 0x0},
        {0x94918, 0x464646, 0x0},
        {0x9491C, 0x474747, 0x0},
        {0x94920, 0x484848, 0x0},
        {0x94924, 0x494949, 0x0},
        {0x94928, 0x4A4A4A, 0x0},
        {0x9492C, 0x4B4B4B, 0x0},
        {0x94930, 0x4C4C4C, 0x0},
        {0x94934, 0x4D4D4D, 0x0},
        {0x94938, 0x4E4E4E, 0x0},
        {0x9493C, 0x4F4F4F, 0x0},
        {0x94940, 0x505050, 0x0},
        {0x94944, 0x515151, 0x0},
        {0x94948, 0x525252, 0x0},
        {0x9494C, 0x535353, 0x0},
        {0x94950, 0x545454, 0x0},
        {0x94954, 0x555555, 0x0},
        {0x94958, 0x565656, 0x0},
        {0x9495C, 0x575757, 0x0},
        {0x94960, 0x585858, 0x0},
        {0x94964, 0x595959, 0x0},
        {0x94968, 0x5A5A5A, 0x0},
        {0x9496C, 0x5B5B5B, 0x0},
        {0x94970, 0x5C5C5C, 0x0},
        {0x94974, 0x5D5D5D, 0x0},
        {0x94978, 0x5E5E5E, 0x0},
        {0x9497C, 0x5F5F5F, 0x0},
        {0x94980, 0x606060, 0x0},
        {0x94984, 0x616161, 0x0},
        {0x94988, 0x626262, 0x0},
        {0x9498C, 0x636363, 0x0},
        {0x94990, 0x646464, 0x0},
        {0x94994, 0x656565, 0x0},
        {0x94998, 0x666666, 0x0},
        {0x9499C, 0x676767, 0x0},
        {0x949A0, 0x686868, 0x0},
        {0x949A4, 0x696969, 0x0},
        {0x949A8, 0x6A6A6A, 0x0},
        {0x949AC, 0x6B6B6B, 0x0},
        {0x949B0, 0x6C6C6C, 0x0},
        {0x949B4, 0x6D6D6D, 0x0},
        {0x949B8, 0x6E6E6E, 0x0},
        {0x949BC, 0x6F6F6F, 0x0},
        {0x949C0, 0x707070, 0x0},
        {0x949C4, 0x717171, 0x0},
        {0x949C8, 0x727272, 0x0},
        {0x949CC, 0x737373, 0x0},
        {0x949D0, 0x747474, 0x0},
        {0x949D4, 0x757575, 0x0},
        {0x949D8, 0x767676, 0x0},
        {0x949DC, 0x777777, 0x0},
        {0x949E0, 0x787878, 0x0},
        {0x949E4, 0x797979, 0x0},
        {0x949E8, 0x7A7A7A, 0x0},
        {0x949EC, 0x7B7B7B, 0x0},
        {0x949F0, 0x7C7C7C, 0x0},
        {0x949F4, 0x7D7D7D, 0x0},
        {0x949F8, 0x7E7E7E, 0x0},
        {0x949FC, 0x7F7F7F, 0x0},
        {0x94A00, 0x808080, 0x0},
        {0x94A04, 0x818181, 0x0},
        {0x94A08, 0x828282, 0x0},
        {0x94A0C, 0x838383, 0x0},
        {0x94A10, 0x848484, 0x0},
        {0x94A14, 0x858585, 0x0},
        {0x94A18, 0x868686, 0x0},
        {0x94A1C, 0x878787, 0x0},
        {0x94A20, 0x888788, 0x0},
        {0x94A24, 0x898889, 0x0},
        {0x94A28, 0x8A898A, 0x0},
        {0x94A2C, 0x8B8A8B, 0x0},
        {0x94A30, 0x8C8B8C, 0x0},
        {0x94A34, 0x8D8C8D, 0x0},
        {0x94A38, 0x8E8D8E, 0x0},
        {0x94A3C, 0x8F8E8F, 0x0},
        {0x94A40, 0x908F90, 0x0},
        {0x94A44, 0x919091, 0x0},
        {0x94A48, 0x929192, 0x0},
        {0x94A4C, 0x939293, 0x0},
        {0x94A50, 0x949394, 0x0},
        {0x94A54, 0x959495, 0x0},
        {0x94A58, 0x969596, 0x0},
        {0x94A5C, 0x979697, 0x0},
        {0x94A60, 0x989698, 0x0},
        {0x94A64, 0x999799, 0x0},
        {0x94A68, 0x9A989A, 0x0},
        {0x94A6C, 0x9B999B, 0x0},
        {0x94A70, 0x9C9A9C, 0x0},
        {0x94A74, 0x9D9B9D, 0x0},
        {0x94A78, 0x9E9C9E, 0x0},
        {0x94A7C, 0x9F9D9F, 0x0},
        {0x94A80, 0xA09EA0, 0x0},
        {0x94A84, 0xA19FA1, 0x0},
        {0x94A88, 0xA2A0A2, 0x0},
        {0x94A8C, 0xA3A1A3, 0x0},
        {0x94A90, 0xA4A2A4, 0x0},
        {0x94A94, 0xA5A3A5, 0x0},
        {0x94A98, 0xA6A4A6, 0x0},
        {0x94A9C, 0xA7A5A7, 0x0},
        {0x94AA0, 0xA8A5A8, 0x0},
        {0x94AA4, 0xA9A6A9, 0x0},
        {0x94AA8, 0xAAA7AA, 0x0},
        {0x94AAC, 0xABA8AB, 0x0},
        {0x94AB0, 0xACA9AC, 0x0},
        {0x94AB4, 0xADAAAD, 0x0},
        {0x94AB8, 0xAEABAE, 0x0},
        {0x94ABC, 0xAFACAF, 0x0},
        {0x94AC0, 0xB0ADB0, 0x0},
        {0x94AC4, 0xB1AEB1, 0x0},
        {0x94AC8, 0xB2AFB2, 0x0},
        {0x94ACC, 0xB3B0B3, 0x0},
        {0x94AD0, 0xB4B1B4, 0x0},
        {0x94AD4, 0xB5B2B5, 0x0},
        {0x94AD8, 0xB6B3B6, 0x0},
        {0x94ADC, 0xB7B4B7, 0x0},
        {0x94AE0, 0xB8B4B8, 0x0},
        {0x94AE4, 0xB9B5B9, 0x0},
        {0x94AE8, 0xBAB6BA, 0x0},
        {0x94AEC, 0xBBB7BB, 0x0},
        {0x94AF0, 0xBCB8BC, 0x0},
        {0x94AF4, 0xBDB9BD, 0x0},
        {0x94AF8, 0xBEBABE, 0x0},
        {0x94AFC, 0xBFBBBF, 0x0},
        {0x94B00, 0xC0BCC0, 0x0},
        {0x94B04, 0xC1BDC1, 0x0},
        {0x94B08, 0xC2BEC2, 0x0},
        {0x94B0C, 0xC3BFC3, 0x0},
        {0x94B10, 0xC4C0C4, 0x0},
        {0x94B14, 0xC5C1C5, 0x0},
        {0x94B18, 0xC6C2C6, 0x0},
        {0x94B1C, 0xC7C3C7, 0x0},
        {0x94B20, 0xC8C3C8, 0x0},
        {0x94B24, 0xC9C4C9, 0x0},
        {0x94B28, 0xCAC5CA, 0x0},
        {0x94B2C, 0xCBC6CB, 0x0},
        {0x94B30, 0xCCC7CC, 0x0},
        {0x94B34, 0xCDC8CD, 0x0},
        {0x94B38, 0xCEC9CE, 0x0},
        {0x94B3C, 0xCFCACF, 0x0},
        {0x94B40, 0xD0CBD0, 0x0},
        {0x94B44, 0xD1CCD1, 0x0},
        {0x94B48, 0xD2CDD2, 0x0},
        {0x94B4C, 0xD3CED3, 0x0},
        {0x94B50, 0xD4CFD4, 0x0},
        {0x94B54, 0xD5D0D5, 0x0},
        {0x94B58, 0xD6D1D6, 0x0},
        {0x94B5C, 0xD7D2D7, 0x0},
        {0x94B60, 0xD8D2D8, 0x0},
        {0x94B64, 0xD9D3D9, 0x0},
        {0x94B68, 0xDAD4DA, 0x0},
        {0x94B6C, 0xDBD5DB, 0x0},
        {0x94B70, 0xDCD6DC, 0x0},
        {0x94B74, 0xDDD7DD, 0x0},
        {0x94B78, 0xDED8DE, 0x0},
        {0x94B7C, 0xDFD9DF, 0x0},
        {0x94B80, 0xE0DAE0, 0x0},
        {0x94B84, 0xE1DBE1, 0x0},
        {0x94B88, 0xE2DCE2, 0x0},
        {0x94B8C, 0xE3DDE3, 0x0},
        {0x94B90, 0xE4DEE4, 0x0},
        {0x94B94, 0xE5DFE5, 0x0},
        {0x94B98, 0xE6E0E6, 0x0},
        {0x94B9C, 0xE7E1E7, 0x0},
        {0x94BA0, 0xE8E1E8, 0x0},
        {0x94BA4, 0xE9E2E9, 0x0},
        {0x94BA8, 0xEAE3EA, 0x0},
        {0x94BAC, 0xEBE4EB, 0x0},
        {0x94BB0, 0xECE5EC, 0x0},
        {0x94BB4, 0xEDE6ED, 0x0},
        {0x94BB8, 0xEEE7EE, 0x0},
        {0x94BBC, 0xEFE8EF, 0x0},
        {0x94BC0, 0xF0E9F0, 0x0},
        {0x94BC4, 0xF1EAF1, 0x0},
        {0x94BC8, 0xF2EBF2, 0x0},
        {0x94BCC, 0xF3ECF3, 0x0},
        {0x94BD0, 0xF4EDF4, 0x0},
        {0x94BD4, 0xF5EEF5, 0x0},
        {0x94BD8, 0xF6EFF6, 0x0},
        {0x94BDC, 0xF7F0F7, 0x0},
        {0x94BE0, 0xF8F0F8, 0x0},
        {0x94BE4, 0xF9F1F9, 0x0},
        {0x94BE8, 0xFAF2FA, 0x0},
        {0x94BEC, 0xFBF3FB, 0x0},
        {0x94BF0, 0xFCF4FC, 0x0},
        {0x94BF4, 0xFDF5FD, 0x0},
        {0x94BF8, 0xFEF6FE, 0x0},
        {0x94BFC, 0xFFF7FF, 0x0},
        {0x90070, 0x0F, 0x0},

};

int m7_mdp_gamma(void)
{
	if (mdp_gamma == NULL)
		return 0;

	mdp_color_enhancement(mdp_gamma, mdp_gamma_count);
	return 0;
}
#endif

static struct msm_panel_common_pdata mdp_pdata = {
	.gpio = MDP_VSYNC_GPIO,
	.mdp_max_clk = 266667000,
	.mdp_max_bw = 4290000000u,
	.mdp_bw_ab_factor = 115,
	.mdp_bw_ib_factor = 200,
#ifdef CONFIG_MSM_BUS_SCALING
	.mdp_bus_scale_table = &mdp_bus_scale_pdata,
#endif
	.mdp_rev = MDP_REV_44,
#ifdef CONFIG_MSM_MULTIMEDIA_USE_ION
	.mem_hid = BIT(ION_CP_MM_HEAP_ID),
#else
	.mem_hid = MEMTYPE_EBI1,
#endif
	.cont_splash_enabled = 0x00,
        //	.mdp_gamma = m7_mdp_gamma,
	.mdp_iommu_split_domain = 1,
};

static char wfd_check_mdp_iommu_split_domain(void)
{
    return mdp_pdata.mdp_iommu_split_domain;
}

#ifdef CONFIG_FB_MSM_WRITEBACK_MSM_PANEL
static struct msm_wfd_platform_data wfd_pdata = {
    .wfd_check_mdp_iommu_split = wfd_check_mdp_iommu_split_domain,
};

static struct platform_device wfd_panel_device = {
    .name = "wfd_panel",
    .id = 0,
    .dev.platform_data = NULL,
};

static struct platform_device wfd_device = {
    .name          = "msm_wfd",
    .id            = -1,
    .dev.platform_data = &wfd_pdata,
};
#endif
void __init m7_mdp_writeback(struct memtype_reserve* reserve_table)
{
	mdp_pdata.ov0_wb_size = MSM_FB_OVERLAY0_WRITEBACK_SIZE;
	mdp_pdata.ov1_wb_size = MSM_FB_OVERLAY1_WRITEBACK_SIZE;
#if defined(CONFIG_ANDROID_PMEM) && !defined(CONFIG_MSM_MULTIMEDIA_USE_ION)
	reserve_table[mdp_pdata.mem_hid].size +=
		mdp_pdata.ov0_wb_size;
	reserve_table[mdp_pdata.mem_hid].size +=
		mdp_pdata.ov1_wb_size;
#endif
}

uint32_t cfg_panel_te_active[] = {GPIO_CFG(LCD_TE, 1, GPIO_CFG_INPUT, GPIO_CFG_NO_PULL, GPIO_CFG_2MA)};
uint32_t cfg_panel_te_sleep[] = {GPIO_CFG(LCD_TE, 0, GPIO_CFG_INPUT, GPIO_CFG_PULL_DOWN, GPIO_CFG_2MA)};

extern int mipi_lcd_on;
static bool dsi_power_on;

static int mipi_dsi_panel_power(int on)
{
	static struct regulator *reg_lvs5, *reg_l2;
	static int gpio36, gpio37;
	static bool bPanelPowerOn = false;
	int rc;

	printk(KERN_ERR "%s: on(%d)\n", __func__, on);
        if (panel_type == PANEL_ID_NONE)
          return -ENODEV;

	if (!dsi_power_on) {
		reg_lvs5 = regulator_get(&msm_mipi_dsi1_device.dev,
				"dsi1_vddio");
		if (IS_ERR_OR_NULL(reg_lvs5)) {
			pr_err("could not get 8921_lvs5, rc = %ld\n",
				PTR_ERR(reg_lvs5));
			return -ENODEV;
		}

		reg_l2 = regulator_get(&msm_mipi_dsi1_device.dev,
				"dsi1_pll_vdda");
		if (IS_ERR_OR_NULL(reg_l2)) {
			pr_err("could not get 8921_l2, rc = %ld\n",
				PTR_ERR(reg_l2));
			return -ENODEV;
		}

		rc = regulator_set_voltage(reg_l2, 1200000, 1200000);
		if (rc) {
			pr_err("set_voltage l2 failed, rc=%d\n", rc);
			return -EINVAL;
		}

		gpio36 = PM8921_GPIO_PM_TO_SYS(V_LCM_N5V_EN); 
		rc = gpio_request(gpio36, "lcd_5v-");
		if (rc) {
			pr_err("request lcd_5v- failed, rc=%d\n", rc);
			return -ENODEV;
		}
		gpio37 = PM8921_GPIO_PM_TO_SYS(V_LCM_P5V_EN); 
		rc = gpio_request(gpio37, "lcd_5v+");
		if (rc) {
			pr_err("request lcd_5v+ failed, rc=%d\n", rc);
			return -ENODEV;
		}
		gpio_tlmm_config(GPIO_CFG(LCD_RST, 0, GPIO_CFG_OUTPUT, GPIO_CFG_NO_PULL, GPIO_CFG_2MA), GPIO_CFG_ENABLE);

		dsi_power_on = true;
	}

	if (on) 
          {
            rc = regulator_set_optimum_mode(reg_l2, 100000);
            if (rc < 0) {
              pr_err("set_optimum_mode l2 failed, rc=%d\n", rc);
              return -EINVAL;
            }
            rc = regulator_enable(reg_l2);
            if (rc) {
              pr_err("enable l2 failed, rc=%d\n", rc);
              return -ENODEV;
            }
            rc = regulator_enable(reg_lvs5);
            if (rc) {
              pr_err("enable lvs5 failed, rc=%d\n", rc);
              return -ENODEV;
            }
            if (!mipi_lcd_on)
              {
                hr_msleep(1);
                gpio_set_value_cansleep(gpio37, 1);
                hr_msleep(2);	
                gpio_set_value_cansleep(gpio36, 1);
                hr_msleep(7);	
                gpio_set_value(LCD_RST, 1);
              }
            
            msm_xo_mode_vote(wa_xo, MSM_XO_MODE_ON);
            hr_msleep(10);
            
            msm_xo_mode_vote(wa_xo, MSM_XO_MODE_OFF);
#if 1
            rc = gpio_tlmm_config(cfg_panel_te_active[0], GPIO_CFG_ENABLE);
            if (rc) {
              pr_err("%s: gpio_tlmm_config(%#x)=%d\n", __func__,
                     cfg_panel_te_active[0], rc);
            }
#endif
            bPanelPowerOn = true;
          } else {
          if (!bPanelPowerOn) return 0;
#if 1
          rc = gpio_tlmm_config(cfg_panel_te_sleep[0], GPIO_CFG_ENABLE);
          if (rc) {
            pr_err("%s: gpio_tlmm_config(%#x)=%d\n", __func__,
                   cfg_panel_te_sleep[0], rc);
          }
#endif
          gpio_tlmm_config(GPIO_CFG(BL_HW_EN, 0, GPIO_CFG_OUTPUT, GPIO_CFG_NO_PULL, GPIO_CFG_2MA), GPIO_CFG_ENABLE);
          gpio_set_value(BL_HW_EN, 0);
          
          gpio_set_value(LCD_RST, 0);
          hr_msleep(3);	
          
          gpio_set_value_cansleep(gpio36, 0);
          hr_msleep(2);
          gpio_set_value_cansleep(gpio37, 0);
          
          hr_msleep(8);	
          rc = regulator_disable(reg_lvs5);
          if (rc) {
            pr_err("disable reg_lvs5 failed, rc=%d\n", rc);
            return -ENODEV;
          }
          
          rc = regulator_disable(reg_l2);
          if (rc) {
            pr_err("disable reg_l2 failed, rc=%d\n", rc);
            return -ENODEV;
          }
          bPanelPowerOn = false;
	}
        
	return 0;
}

static struct mipi_dsi_platform_data mipi_dsi_pdata = {
	
	.dsi_power_save = mipi_dsi_panel_power,
};

static struct platform_device mipi_dsi_m7_panel_device = {
	.name = "mipi_m7",
	.id = 0,
};

#if 0
static const struct i2c_device_id pwm_i2c_id[] = {
	{ "pwm_i2c", 0 },
	{ }
};

static int pwm_i2c_probe(struct i2c_client *client,
			const struct i2c_device_id *id)
{
	int rc;

	if (!i2c_check_functionality(client->adapter,
				     I2C_FUNC_SMBUS_BYTE | I2C_FUNC_I2C))
		return -ENODEV;

	blk_pwm_client = client;

	return rc;
}

static struct i2c_driver pwm_i2c_driver = {
	.driver = {
		.name = "pwm_i2c",
		.owner = THIS_MODULE,
	},
	.probe = pwm_i2c_probe,
	.remove =  __exit_p( pwm_i2c_remove),
	.id_table =  pwm_i2c_id,
};
static void __exit pwm_i2c_remove(void)
{
	i2c_del_driver(&pwm_i2c_driver);
}
#endif

static void __init apq8064_set_display_params(char *prim_panel, char *ext_panel)
{
	if (strnlen(prim_panel, PANEL_NAME_MAX_LEN)) {
		strlcpy(msm_fb_pdata.prim_panel_name, prim_panel,
			PANEL_NAME_MAX_LEN);
		pr_debug("msm_fb_pdata.prim_panel_name %s\n",
			msm_fb_pdata.prim_panel_name);
	}

	if (strnlen(ext_panel, PANEL_NAME_MAX_LEN)) {
		strlcpy(msm_fb_pdata.ext_panel_name, ext_panel,
			PANEL_NAME_MAX_LEN);
		pr_debug("msm_fb_pdata.ext_panel_name %s\n",
			msm_fb_pdata.ext_panel_name);
	}
}

void __init m7_init_fb(void)
{
        apq8064_set_display_params("mipi_m7", "hdmi_msm");
	platform_device_register(&msm_fb_device);

	if (panel_type == PANEL_ID_M7_SHARP_RENESAS)
		mdp_pdata.cont_splash_enabled = 0x1;

	if(panel_type != PANEL_ID_NONE) {
                platform_device_register(&mipi_dsi_m7_panel_device);
		msm_fb_register_device("mdp", &mdp_pdata);
		msm_fb_register_device("mipi_dsi", &mipi_dsi_pdata);
		wa_xo = msm_xo_get(MSM_XO_TCXO_D0, "mipi");
	}
	msm_fb_register_device("dtv", &dtv_pdata);
#ifdef CONFIG_FB_MSM_WRITEBACK_MSM_PANEL
	platform_device_register(&wfd_panel_device);
	platform_device_register(&wfd_device);
#endif
}
